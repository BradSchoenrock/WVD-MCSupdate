
\chapter{Data}
\label{CH-Data}

\section{Raw Data Output}
\label{Sec-DATAOutput}

\subsection{Raw File Naming Convention}
 A naming convention for the files written is proposed as:

\begin{enumerate}
\item{MCS Data: NCARWVDIAL\#\#\#\_MCS\_YYYYMMDD\_HHMMSS.cdf where \#\#\# is the number of the instrument, YYYYMMDD is the year, month and day of the file creation, and HHMMSS is the hour, minute, and second of file creation.}
\item{Weather Station Data: NCARWVDIAL\#\#\#\_WeatherStation\_YYYYMMDD\_HHMMSS.cdf where \#\#\# is the number of the instrument, YYYYMMDD is the year, month and day of the file creation, and HHMMSS is the hour, minute, and second of file creation.}
\item{Transmitter Housekeeping Data: NCARWVDIAL\#\#\#\_HousekeepingTx\_YYYYMMDD\_HHMMSS.cdf where \#\#\# is the number of the instrument, YYYYMMDD is the year, month and day of the file creation, and HHMMSS is the hour, minute, and second of file creation.}
\item{Receiver Housekeeping Data: NCARWVDIAL\#\#\#\_HousekeepingRx\_YYYYMMDD\_HHMMSS.cdf where \#\#\# is the number of the instrument, YYYYMMDD is the year, month and day of the file creation, and HHMMSS is the hour, minute, and second of file creation.}
\end{enumerate}

\subsection{Main Data Product Changes}

The main changes from previous architecture and how those changes help accomplish design goals are listed below.
\begin{enumerate}
\item{NetCDF file types instead of binary files.}
	\begin{enumerate}
		\item{Pros:
			\begin{enumerate}
				\item{Expandable and customizable to different hardware configurations or improvements.}
				\item{Can be easily converted to have outputs to mirror the GV HSRL or in CFRadial format.}
				\item{Can be easily read and understood by non-NCAR personnel lacking knowledge of binary format.}
				\end{enumerate}
		}
		\item{Cons:
			\begin{enumerate}
				\item{Requires a change to the post processing ingest code.}
				\item{As far as I can tell, only allows for a single unlimited variable making it not possible to stream data at different cadences to the same file efficiently.}
				\end{enumerate}
		}
	\end{enumerate}
\item{Multiple files containing data instead of a single file per hour. The plan is to split the hourly files into a file containing: all photon counts and power measurements (measurements from the MCS), weather station data, laser housekeeping and locking data, and receiver housekeeping data. Additionally, on restart, a new netCDF file will be created instead of reopening the current hour's file.}
	\begin{enumerate}
		\item{Pros:
			\begin{enumerate}
				\item{Data for WV DIAL can be taken at different cadences. Though the current architecture can accommodate all data being taken at the same cadence, it is not necessary. There is no physical reason to take weather station data at 2 second resolution for example. By allowing multiple files, data can be taken at physically meaningful resolution and recombined in post processing.}
				\item{Shrinks data files: Removing the requirement to take data at the same resolution removes redundant measurements.}
				\item{Data transfer flexibility: Over limited data transfer links, such as a cell modem or at bandwidth limited sites, the most critical data can be identified and transferred while still saving all data for post processing.}
				\item{Hardware changes or major changes requiring Labview shutdown can be easily tracked by file header information.}
			\end{enumerate}
		}
		\item{Cons:
			\begin{enumerate}
				\item{Data requires recombination to a single time grid in post processing.}
				\item{The proposed split may require multiple VIs talk to the same hardware. This will require an access check before writing commands to make sure that two commands are not sent simultaneously that confuses the hardware.}
			\end{enumerate}
		}
	\end{enumerate}
\item{Writing photon counting data at native resolution regardless of the state of the transmitter or receiver. This requires status bits being recorded instead of only recording data when all status bits indicate good data.}
	\begin{enumerate}
		\item{Pros:
			\begin{enumerate}
				\item{Data is not missed for one laser while other lasers are locking.}
				\item{Data collection decoupled from all other data makes sure you are not loosing data for a reason other than MCS failure. For example, if the HSRL laser turns off, the system will be stuck trying to lock a laser it can't find. Meanwhile, WV data is lost that is not necessarily bad. }
			\end{enumerate}
		}
		\item{Cons:
			\begin{enumerate}
				\item{Data file must now include status flags that were not needed before.}
			\end{enumerate}
		}
	\end{enumerate}
%\item{C}
%	\begin{enumerate}
%		\item{Pros:
%			\begin{enumerate}
%				\item{1.}
%				\item{2.}
%				\item{3.}
%			\end{enumerate}
%		}
%		\item{Cons:
%			\begin{enumerate}
%				\item{1.}
%				\item{2.}
%			\end{enumerate}
%		}
%	\end{enumerate}
\end{enumerate}


\newpage




\section{Raw Data Ingest and Mating with Python Scripts}


Steps of unpacking a single day of data:
\begin{enumerate}
	\item{Loop over hourly folders (I prefer to dump all data into a single daily directory but that is a convenience not a necessity)}
	\begin{enumerate}
		\item{Loop over hourly file types (more that one of each type can be written if the labview is started more than once in a single hour or restarted)}
			\begin{enumerate}
				\item{Check if particular file contains data (by checking for zero-valued dimensions)}
				\item{Loading raw photon count data}
				\item{Loading laser housekeeping data}
				\item{Loading weather station data}
				\item{Loading the operational parameters of the system and time stamps for each file type}
			\end{enumerate}
		\item{Interpolate slower data to highest cadence data (likely housekeeping and weather station data to photon count time grid)}
		\item{Collect all data into a single daily file with a single time dimension}
		\item{Fill in missing data in time (if any time gaps exist) with nan values}
		\item{Combine laser locking, receiver temperature, and all other data flags and create a single quality control flag: (Use Data, Data Warning, or Don't Use)}
	\end{enumerate}
\end{enumerate}


\newpage

